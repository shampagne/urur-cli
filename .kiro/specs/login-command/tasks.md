# Implementation Plan

- [x] 1. OAuth コールバック用ローカル HTTP サーバーの構築
- [x] 1.1 (P) コールバック待機サーバーの実装
  - 指定ポートで HTTP サーバーを起動し、`/callback` パスで認可コードを受け取る機能を作成する
  - コールバック受信後、ブラウザに「認証完了。ターミナルに戻ってください」と HTML レスポンスを返す
  - 認可コードを Promise で返し、サーバーを自動的に閉じる
  - _Requirements: 1.1, 1.2, 2.2_

- [x] 1.2 (P) エラーハンドリングとタイムアウトの実装
  - ポートが使用中（`EADDRINUSE`）の場合にわかりやすいエラーを返し、`--port` での別ポート指定を案内する
  - コールバック URL に `error` パラメータが含まれる場合にエラーとして処理する
  - 60秒のタイムアウトを設け、超過時にサーバーをシャットダウンしてタイムアウトメッセージを返す
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 2. Supabase クライアントの PKCE フロー対応
  - 既存の Supabase クライアント生成に PKCE フロー設定（`flowType: 'pkce'`）を追加する
  - インメモリのストレージアダプターを作成し、`code_verifier` を保持できるようにする（Node.js には `localStorage` がないため）
  - クライアントが `signInWithOAuth` と `exchangeCodeForSession` を正しく利用できることを確認する
  - _Requirements: 1.3, 2.1_

- [x] 3. login コマンドのオーケストレーション
- [x] 3.1 既存ログイン状態の確認と再ログインフロー
  - コマンド実行時に保存済み認証情報を読み込み、有効なトークンが存在するか確認する
  - 既にログイン済みの場合、ユーザー名を表示し、再ログインするか確認プロンプトを表示する
  - ユーザーが再ログインを選択した場合は既存認証情報を削除して認証フローに進む
  - ユーザーがキャンセルした場合は何もせず正常終了する
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 3.2 OAuth 認証フローの実行
  - Supabase の `signInWithOAuth` で GitHub OAuth URL を取得する（ブラウザリダイレクトはスキップ）
  - ローカルサーバーを起動し、ブラウザで OAuth URL を開く
  - スピナーを表示して認証待ち状態をユーザーに伝える
  - コールバックで受け取った認可コードを `exchangeCodeForSession` でトークンに交換する
  - アクセストークン・リフレッシュトークン・有効期限をローカルに保存する
  - 認証されたユーザー名を表示し、成功メッセージを出力して正常終了する
  - すべてのエラーケースでスピナー停止・サーバーシャットダウン・赤色エラーメッセージ表示を行う
  - _Requirements: 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3_

- [x] 4. ユニットテスト
- [x] 4.1 (P) コールバックサーバーのテスト
  - 実際にローカルサーバーを起動し、HTTP リクエストでコールバックを送信して認可コードが正しく返ることを検証する
  - タイムアウト時にサーバーが閉じられ、適切なエラーが返ることを検証する
  - 使用中ポートでの起動時にポート競合エラーが返ることを検証する
  - コールバックにエラーパラメータが含まれる場合の処理を検証する
  - _Requirements: 5.1, 5.2_

- [x] 4.2 (P) login コマンドの統合テスト
  - 既存認証情報がない場合に認証フローが開始されることを検証する（Supabase・open・ora はモック）
  - 既存認証情報がある場合に再ログイン確認が表示されることを検証する
  - 再ログインキャンセル時に何もせず終了することを検証する
  - OAuth フロー成功時にトークンが保存され、ユーザー名が表示されることを検証する
  - _Requirements: 5.1, 5.3_

- [x]* 4.3 (P) Supabase PKCE クライアントのテスト
  - インメモリストレージアダプターの `getItem`/`setItem`/`removeItem` が正しく動作することを検証する
  - PKCE 設定付きの Supabase クライアントが正しく生成されることを検証する
  - _Requirements: 5.1_
