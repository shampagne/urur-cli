# Implementation Plan

- [x] 1. Web 側バリデーション関数の実装とテスト
- [x] 1.1 (P) redirect_uri のバリデーション関数を実装する
  - `http://127.0.0.1:{port}` と `http://localhost:{port}` のみを許可するバリデーションロジックを作成する
  - URL パースに失敗した場合は例外を投げずに false を返す
  - https、外部ドメイン、ポート無し、空文字列などの異常系も false を返す
  - テストを先に書き（RED）、バリデーション関数を実装して通す（GREEN）
  - _Requirements: 3.1_

- [x] 1.2 (P) oauth_url のバリデーション関数を実装する
  - oauth_url のホスト名が指定された Supabase URL のホスト名と一致するかを検証する
  - URL パースに失敗した場合は例外を投げずに false を返す
  - ホスト名不一致、不正 URL 形式、空文字列などの異常系も false を返す
  - テストを先に書き（RED）、バリデーション関数を実装して通す（GREEN）
  - _Requirements: 3.2_

- [x] 2. Web 側同意ページルートの実装
- [x] 2.1 同意ページのサーバーサイドバリデーションとルーティングを実装する
  - クエリパラメータ `oauth_url` と `redirect_uri` をサーバー側で検証する
  - パラメータ欠落時はエラーメッセージ「必要なパラメータが不足しています」を表示する
  - redirect_uri が不正な場合はエラーメッセージ「不正なリダイレクト先です」を表示する
  - oauth_url が不正な場合はエラーメッセージ「不正な認証 URL です」を表示する
  - バリデーション成功時のみ同意 UI をレンダリングする
  - 1.1, 1.2 のバリデーション関数に依存
  - _Requirements: 3.3, 3.4, 3.5_

- [x] 2.2 同意ページの UI を実装する
  - 「urur CLI にログインしますか？」の確認メッセージを表示する
  - 承認ボタンを配置し、クリック時に `data-oauth-url` 属性から取得した OAuth URL にリダイレクトする
  - キャンセルボタンを配置し、クリック時にウィンドウを閉じる
  - 既存のログインページと同じデザインシステム（中央カード、Space Mono ロゴ、ink/paper カラー）を使用する
  - Supabase CDN やクライアントライブラリは読み込まない
  - 2.1 のバリデーション結果に依存
  - _Requirements: 1.2, 1.3, 1.4, 1.5, 2.2, 4.1, 4.2_

- [x] 3. CLI 側 WEB_URL ビルド時定数の追加
- [x] 3.1 (P) ビルド時定数 WEB_URL を CLI の設定に追加する
  - 設定ファイルに WEB_URL のビルド時定数を宣言し export する
  - ビルド設定に WEB_URL の定数注入を追加する（デフォルト値: `https://urur.dev`）
  - テスト設定に WEB_URL の定数注入を追加する（テスト用値: `http://localhost:5173`）
  - 環境変数ファイルとサンプルファイルに WEB_URL エントリを追加する
  - 既存の SUPABASE_URL / SUPABASE_ANON_KEY と同一のパターンを踏襲する
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 4. CLI 側 login コマンドの修正
- [x] 4.1 login コマンドで同意ページ URL を開くように変更する
  - OAuth URL を直接ブラウザで開く代わりに、同意ページ URL を構築してブラウザで開く
  - 同意ページ URL は WEB_URL をベースに `/cli/consent` パスを結合する
  - oauth_url と redirect_uri をクエリパラメータとしてエンコードして付与する
  - PKCE の code_verifier はインメモリに保持したまま（既存動作を変更しない）
  - 3.1 の WEB_URL 定数に依存
  - _Requirements: 1.1, 2.1, 2.3_

- [x] 4.2 login コマンドのテストを更新する
  - `open()` の呼び出し引数が同意ページ URL であることを検証する
  - 同意ページ URL に oauth_url パラメータがエンコードされて含まれることを検証する
  - カスタムポート指定時に redirect_uri パラメータが正しいポート番号を含むことを検証する
  - WEB_URL が同意ページ URL のベースとして使用されることを検証する
  - 4.1 の実装に依存
  - _Requirements: 1.1, 2.1, 5.1_
